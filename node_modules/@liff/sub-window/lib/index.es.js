import{__awaiter as e,__generator as t,__read as n,__spreadArray as r,__extends as i}from"tslib";import{LiffModule as o}from"@liff/use";import{isInClient as s}from"@liff/is-in-client";import{validators as u}from"@liff/is-api-available";import{STORE_KEY as a,INVALID_CONFIG as c,EXCEPTION_IN_SUBWINDOW as f,SUB_WINDOW_STATUS as l,CREATE_SUBWINDOW_FAILED as d,SUB_WINDOW_IDNTIFICATION_KEY as m,INVALID_ARGUMENT as v,SUB_WINDOW_HEALTH_CHECK_MESSAGE as p,SUB_WINDOW_HEALTH_CHECK_INTERVAL as h,SUB_WINDOW_MONITOR_CLOSE_INTERVAL as w,UNKNOWN as g,UNAUTHORIZED as b,SUB_WINDOW_MODAL_SCHEME_URL as y}from"@liff/consts";import{logger as S}from"@liff/logger";import{createLiffError as I,InMemoryStorage as O,isNonBrowserEnvironment as P,isIpad as C,extractLiffId as L}from"@liff/util";import{getOS as E}from"@liff/get-os";import{getEndPoint as N,fetch as T,requestWithoutErrorHandling as j}from"@liff/server-api";import{getConfig as M,getMSTChallenge as D,getMST as B,getAppData as J}from"@liff/store";import{WINDOW as R,MessageBus as U,IDENTIFIER_KEY as W,CRYPTO_KEY as A}from"@liff/message-bus";import{isSubWindow as x}from"@liff/is-sub-window";import{closeWindow as k}from"@liff/close-window";function K(e){var t=N("subWindowGetOrigin");return T(t(e))}var G={};function V(e,t){e&&G[e]&&G[e].forEach((function(e){e(t)}))}var F,_,q,z,H,Q=function(){function e(e){this.storage=e}return e.prototype.getItem=function(e){return this.storage.getItem("".concat(this.getKeyPrefix(),":").concat(e))},e.prototype.setItem=function(e,t){this.storage.setItem("".concat(this.getKeyPrefix(),":").concat(e),t)},e.prototype.removeItem=function(e){this.storage.removeItem("".concat(this.getKeyPrefix(),":").concat(e))},e.prototype.clear=function(){this.storage.clear()},e.prototype.getKeyPrefix=function(){return"".concat(a,":").concat(this.getLiffId())},e.prototype.getLiffId=function(){var e=M().liffId;if(!e)throw I(c,"liffId is necessary for liff.init()");return e},e}(),X=new Q(new O);function Y(){var e=X.getItem("subWindowStatusUpdated");return null!==e&&JSON.parse(e)}function Z(e){X.setItem("subWindowStatusUpdated",String(e))}function $(e){F=e}function ee(){return F}function te(){return q}function ne(){return z}function re(n){return void 0===n&&(n=R.MAIN),e(this,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return[4,(H=new U(n)).setup()];case 1:return e.sent(),[2,H]}}))}))}function ie(){return H}var oe=new O,se=new Q(P()?oe:window.sessionStorage);function ue(e){se.setItem("mainWindowOrigin",e)}function ae(){return se.getItem("mainWindowOrigin")}function ce(n,r){return void 0===r&&(r={}),e(this,void 0,void 0,(function(){var e,i,o,s,u,a,c,d;return t(this,(function(t){switch(t.label){case 0:if(null==(e=ie())?void 0:e.isReady())return[3,5];if(i=JSON.stringify(r),o=M().liffId,s=ae(),!window.opener||!s||!o)throw I(f);u=!1,t.label=1;case 1:return t.trys.push([1,3,,4]),[4,K(o)];case 2:return a=t.sent(),u=a.subwindowCommonModule,[3,4];case 3:throw c=t.sent(),S.debug(c),I(f);case 4:return d=u?s:location.origin,[2,new Promise((function(e){window.addEventListener("message",(function t(r){(function(e){if(e.data&&"string"==typeof e.data.type&&[l.SUBMIT,l.CANCEL].includes(e.data.type))return!0;return!1})(r)&&(window.removeEventListener("message",t),e({status:n,result:i}))})),window.opener.postMessage({status:n,result:i},d)}))];case 5:return e.send({eventName:n,data:r}),[4,new Promise((function(e){setTimeout(e,500)}))];case 6:return t.sent(),[2,{status:n,result:JSON.stringify(r)}]}}))}))}function fe(e){var t,n=ne();if(e.origin===n){var r=e.data;if(r){var i,o=r.status,s=r.result;try{i=JSON.parse(s||"{}")}catch(u){i={}}switch(o){case p:window.clearInterval(te()),ve();break;case l.CANCEL:case l.SUBMIT:Z(!0),window.clearInterval(te()),window.removeEventListener("message",fe),V(o,i),null===(t=ee())||void 0===t||t.postMessage({type:o},ne());break;default:S.debug("unexpected message")}}}}var le=function(n){return e(void 0,void 0,void 0,(function(){var e,r,i,o;return t(this,(function(t){if(Y())return[2];switch(e=n.context,r=e.eventName,i=e.data,o=ie(),r){case l.INIT:me(!i.hasOpener);break;case l.CANCEL:case l.SUBMIT:Z(!0),V(r,i),null==o||o.reply(n,{eventName:r});break;case l.CLOSE:!1===Y()&&(Z(!0),V(l.CLOSE,{})),ve()}return[2]}))}))};function de(){window.clearInterval(_),window.clearInterval(te()),window.removeEventListener("message",fe)}function me(e){if(void 0===e&&(e=!1),de(),Z(!1),e){var t=ee();t&&(t.close(),$(null))}}function ve(){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){switch(t.label){case 0:return(e=ie())?[4,e.teardown()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))}function pe(i){return e(this,void 0,void 0,(function(){var e,o,s,u,a,c,f,g,b,y;return t(this,(function(t){switch(t.label){case 0:return(e=L(i.url))?(me(!0),[4,ve()]):[2,Promise.reject(I(v,"params.url must be liff url"))];case 1:return t.sent(),$("ios"!==E()||C()?window.open("","liffsubwindow","width=480, height=640, menubar=no, toolbar=no, scrollbars=yes"):window.open()),o=i.url,s=i.appData,(u=new URL(o)).searchParams.append(m,"true"),[4,re()];case 2:return a=t.sent(),u.searchParams.append(W,a.identification.identifier),u.searchParams.append(A,a.identification.cryptoKey),u.hostname=function(e){var t=n(e.split(".")),i=t[0],o=t.slice(1);return r(["".concat(i,"-ext")],n(o),!1).join(".")}(u.hostname),c=u.toString(),[4,K(e)];case 3:if(f=t.sent(),g=f.origin,b=f.subwindowCommonModule,!(y=ee()))throw I(d);return b?(function(e){z=e}(g),a.listen(le),a.setData("appData",s),window.addEventListener("message",fe),y.location.href=c,S=function(e,t){var n=ee(),r={type:p};return t&&(r.message=JSON.stringify(t)),window.setInterval((function(){null==n||n.postMessage(r,e)}),h)}(g,s),q=S,function(e){_=e}(window.setInterval((function(){var e=ee();e&&e.closed&&(de(),$(null),!1===Y()&&(Z(!0),V(l.CLOSE,{})))}),w)),[2]):(y.close(),[2])}var S}))}))}var he=null;function we(i){return e(this,void 0,void 0,(function(){var o,s,u,a,c,f,d,m,p,h,w,b,y,S,O=this;return t(this,(function(P){switch(P.label){case 0:if(o=i.msit,s=i.mstChallenge,u=i.reconnectCount,a=void 0===u?0:u,c=function(){return e(O,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return[4,(t=1e3,new Promise((function(e){return setTimeout(e,t)})))];case 1:return e.sent(),[4,we({msit:o,mstChallenge:s,onSuccess:i.onSuccess,onError:i.onError,reconnectCount:a+1})];case 2:return e.sent(),[2]}var t}))}))},f=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];he=null,i.onSuccess.apply(i,r([],n(e),!1))},d=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];he=null,i.onError.apply(i,r([],n(e),!1))},m=Date.now(),null===he&&(he=m),p=m-he,a>=10||p>6e5)return d(I(g,"Failed to connect")),[2];P.label=1;case 1:return P.trys.push([1,3,,5]),[4,j(N("subWindowSubscribe"),{method:"POST",body:JSON.stringify({msit:o,mstChallenge:s})})];case 2:return h=P.sent(),[3,5];case 3:return P.sent(),[4,c()];case 4:return P.sent(),[2];case 5:return h.status>=500?[4,c()]:[3,7];case 6:return P.sent(),[3,17];case 7:return h.status>=400&&500>h.status?[4,ge(h)]:[3,9];case 8:return b=P.sent(),w=b?I(v,b.errorDetail):I(g,"Some error happened in the server"),d(w),[3,17];case 9:return 200!==h.status?[3,16]:[4,ge(h)];case 10:if(!(b=P.sent()))return d(I(g,"Some error happened in the server")),[2];switch(y=b.status,S=b.result,y){case l.ERROR:return[3,11];case l.CLOSE:case l.CANCEL:case l.SUBMIT:return[3,13]}return[3,14];case 11:return[4,c()];case 12:return P.sent(),[3,15];case 13:return f(y,S),[3,15];case 14:d(I(g,"Some error happened in the server")),P.label=15;case 15:return[3,17];case 16:d(I(g,"Some error happened in the server")),P.label=17;case 17:return[2]}}))}))}function ge(n){return e(this,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,n.json()];case 1:return[2,e.sent()];case 2:return e.sent(),[2,null];case 3:return[2]}}))}))}function be(e){var t={};return Object.keys(e).forEach((function(n){"closeButtonColor"===n?"white"===e[n]?t[n]="#ffffff":t[n]="#000000":t[n]=e[n]})),t}var ye={height:"full",closeButtonPosition:"right",closeButtonColor:"black",closeButtonLabel:""};function Se(e){var t=e.appData,n=e.native,r=M().liffId,i=D(),o=L(e.url);if(!r)return Promise.reject(I(b,"liffId is invalid"));if(!i)return Promise.reject(I(b,"mst_challenge is invalid"));if(!o)return Promise.reject(I(v,"params.url must be liff url"));var s=Object.assign({},ye,n);return function(e){var t=e.mainLiffId,n=e.subLiffId,r=e.mstChallenge,i=e.appData,o=e.view;return t&&r?T(N("subWindowGetMSIT"),{method:"POST",body:JSON.stringify({mainLiffId:t,subLiffId:n,mstChallenge:r,appData:i,view:o})}):Promise.reject(I(v,"no proper argument"))}({mainLiffId:r,subLiffId:o,mstChallenge:i,appData:t,view:be(s)}).then((function(t){var n=t.msit;we({msit:n,mstChallenge:i,onSuccess:function(e,t){V(e,t)},onError:function(e){V(l.ERROR,e)}}),function(e,t){var n=e.url,r=new URLSearchParams;r.set("msit",t),location.href="".concat(y,"?url=").concat(encodeURIComponent(n),"&").concat(r.toString())}(e,n)}))}function Ie(e){if(!e.mst||!e.status)return Promise.reject(I(v,"no proper argument"));var t=JSON.stringify(e);return T(N("subWindowPost"),{method:"POST",body:t})}function Oe(){if(!x())throw I(b,"this api can be only called in child window")}function Pe(e){var t=e.msit,n=e.mstVerifier;return t&&n?T(N("subWindowGetMSTByMSIT"),{method:"POST",body:JSON.stringify({msit:t,mstVerifier:n})}):Promise.reject(I(v,"no proper argument"))}function Ce(e){var t=e.mst;return t?T(N("subWindowGetAppData"),{method:"POST",body:JSON.stringify({mst:t})}):Promise.reject(I(v,"no proper argument"))}var Le={on:function(e,t){G[e]||(G[e]=[]),G[e].push(t)},off:function(e,t){if(G[e]){var n=G[e].indexOf(t);n>=0&&G[e].splice(n,1)}},open:function(e){return u.subwindowOpen(),s()?Se(e):pe(e)},cancel:function(n){return void 0===n&&(n={}),Oe(),s()?function(n){return void 0===n&&(n={}),e(this,void 0,void 0,(function(){var e,r;return t(this,(function(t){switch(t.label){case 0:return(e=B())?[4,Ie({mst:e,status:l.CANCEL,result:n})]:[2,Promise.reject(I(b,"mst is invalid"))];case 1:return r=t.sent(),Z(!0),[2,r]}}))}))}(n):function(e){return void 0===e&&(e={}),ce(l.CANCEL,e)}(n)},submit:function(n){return void 0===n&&(n={}),Oe(),s()?function(n){return void 0===n&&(n={}),e(this,void 0,void 0,(function(){var e,r;return t(this,(function(t){switch(t.label){case 0:return(e=B())?[4,Ie({mst:e,status:l.SUBMIT,result:n})]:[2,Promise.reject(I(b,"mst is invalid"))];case 1:return r=t.sent(),Z(!0),[2,r]}}))}))}(n):function(e){return void 0===e&&(e={}),ce(l.SUBMIT,e)}(n)},close:function(){return Oe(),s()?function(){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){switch(t.label){case 0:return!1!==Y()?[3,2]:(e=B())?[4,Ie({mst:e,status:l.CLOSE,result:{}})]:[2,Promise.reject(I(b,"mst is invalid"))];case 1:t.sent(),t.label=2;case 2:return k(),[2]}}))}))}():function(){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){return(null==(e=ie())?void 0:e.isReady())?(e.send({eventName:l.CLOSE}),[2,new Promise((function(e){setTimeout((function(){k(),e()}),h)}))]):(k(),[2,Promise.resolve()])}))}))}()},getAppData:function(){return Oe(),function(){var e,t=J();try{e=t?JSON.parse(t):{}}catch(n){e={}}return Promise.resolve(e)}()}},Ee=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),Object.defineProperty(t.prototype,"name",{get:function(){return"subWindow"},enumerable:!1,configurable:!0}),t.prototype.install=function(){return Le},t}(o);export{Ee as SubWindowModule,Ce as getAppData,Pe as getMSTByMSIT,ae as getMainWindowOrigin,ie as getMessageBus,re as initMessageBus,ue as setMainWindowOrigin,Le as subWindow};
