import{__spreadArray as t,__read as n,__extends as r,__awaiter as e,__generator as i}from"tslib";import{INVALID_ARGUMENT as a,CREDENTIAL_KEYS as o,INIT_FAILED as s,INVALID_CONFIG as c,PERMANENT_LINK_ORIGIN as u}from"@liff/consts";import{createLiffError as f}from"@liff/util";import{getContext as l,getConfig as h}from"@liff/store";import{LiffModule as p}from"@liff/use";var m=/([\x90\x9D\x81\x8D\x8F<"{|}>\\^`“›„•‚ŽŠ…’—ž–‘”‡™‰ŒšŸ‹œ†¥¿©áÄýÍÎðô]|\n|.*#.*#|%(?![0-9A-Fa-f]{2})[^%]{0,2})/,g=function(t){if(m.test(t))throw f(a,"invalid URL.");var n=new URL(t),r=n.username,e=n.password,i=n.hash,o=n.search;return{username:r,password:e,pathname:n.pathname,hash:i,origin:n.origin,search:o.replace(/(?:^|;|&)([^;&]*)[;&]*(?=($|;|&))/g,"$1&").replace(/&+$/g,"").replace(/^\?&/,"?")}},d=function(t){return t.substring(1).split("&").filter((function(t){return!/^liff\./.test(t)&&Boolean(t)}))},v=function(t,n){var r=t.substring(n.length);return"/"===r?"":(r.length>0&&"/"!==r[0]&&(r="/"+r),r)},x=function(r,e){var i,a,o,s=function(r,e){for(var i=t([],n(r),!1),a=0;a<e.length;a++){var o=e[a],s=i.indexOf(o);s>-1&&i.splice(s,1)}return i}((i=d(r).join("&"),a=new URLSearchParams(i).toString().split("&"),o=i.split("&"),a.map((function(t,n){return t.endsWith("=")&&!o[n].endsWith("=")?t.slice(0,-1):t}))),d(e)).join("&");return""!==s?"?".concat(s):""},w=function(t){var n=new RegExp("^".concat(o.join("|"))),r=t.substring(1).split("&").filter((function(t){return!n.test(t)&&Boolean(t)})).join("&");return r?"#".concat(r):""},U=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.extraParams="",n.getAndValidateContext=function(){var t=l();if(!t)throw f(s,"Could not get Context from server.");if(!t.endpointUrl)throw f(s,"Could not get endpointUrl from server.");if(!t.permanentLinkPattern)throw f(s,"Could not get permanentLinkPattern from server.");return t},n.createUrl=function(){var t=n.getAndValidateContext(),r=window.location,e=r.pathname,i=r.search,a=r.hash,s=r.origin,l=new URL(t.endpointUrl);if(l.origin!==s||!n.isAncestor(l.pathname,e))throw f(c,"Current page is not under entrypoint.");var p=e.substring(l.pathname.length);p.length>0&&"/"!==p[0]&&(p="/"+p);var m=new RegExp("^".concat(o.join("|"))),g=a.substring(1).split("&").filter((function(t){return!m.test(t)&&Boolean(t)})).join("&"),d=g===l.hash.substring(1)?"":g,v=function(t){return t.substring(1).split("&").filter((function(t){return!/liff\.state/.test(t)&&Boolean(t)}))},x=v(i),w=v(l.search);n.extraParams&&x.push(n.extraParams);for(var U=0;U<w.length;U++){var b=w[U],P=x.indexOf(b);P>-1&&x.splice(P,1)}var y=x.join("&"),L="".concat(p).concat(""!==y?"?".concat(y):"").concat(d?"#".concat(d):"");return"".concat(u).concat(h().liffId).concat(L)},n.createUrlBy=function(t){return e(n,void 0,void 0,(function(){var n,r,e,o;return i(this,(function(i){if(!(n=h().liffId))throw f(s,"Should run after liff init.");if(r=this.getAndValidateContext(),e=g(t),o=new URL(r.endpointUrl),e.username!==o.username||e.password!==o.password)throw f(a,"invalid URL.");if(o.origin!==e.origin||!this.isAncestor(o.pathname,e.pathname))throw f(a,"invalid URL.");return[2,u.concat(n,v(e.pathname,o.pathname),x(e.search,o.search),w(e.hash))]}))}))},n.setExtraQueryParam=function(t){n.extraParams=t},n.isAncestor=function(t,n){return 0===n.indexOf(t)&&(t.endsWith("/")&&(t=t.substring(0,t.length-1)),void 0===n[t.length]||"/"===n[t.length])},n.install=function(){return{createUrl:n.createUrl,createUrlBy:n.createUrlBy,setExtraQueryParam:n.setExtraQueryParam}},n}return r(n,t),Object.defineProperty(n.prototype,"name",{get:function(){return"permanentLink"},enumerable:!1,configurable:!0}),n}(p),b=new U;export{U as PermanentLinkModule,b as module};
